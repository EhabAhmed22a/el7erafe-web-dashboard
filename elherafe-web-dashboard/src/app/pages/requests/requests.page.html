<div class="flex flex-col h-screen" dir="rtl">
    <!-- Header (full width on top) -->
    <app-header (menuToggle)="toggleSidebar()"></app-header>

    <!-- Content Area -->
    <div class="flex flex-1 overflow-hidden bg-gray-200 relative">
        <!-- Sidebar -->
        <div class="hidden lg:block">
            <app-sidebar class="shrink-0"></app-sidebar>
        </div>

        <!-- Mobile Sidebar Overlay -->
        @if (sidebarOpen) {
        <div class="fixed inset-0 z-40 flex lg:hidden">
            <div class="absolute inset-0 bg-black/50" (click)="closeSidebar()"></div>
            <div class="relative ml-auto h-full w-64 bg-white shadow-2xl">
                <button type="button" class="absolute top-3 left-3 text-gray-500 hover:text-gray-700" (click)="closeSidebar()" aria-label="إغلاق القائمة">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
                </button>
                <app-sidebar class="h-full pt-10"></app-sidebar>
            </div>
        </div>
        }

        <!-- Main Content -->
        <main class="flex-1 p-4 bg-white overflow-auto m-3 rounded-2xl text-sm">
            <h1 class="text-xl text-blue-700">طلبات التسجيل كحرفي</h1>
            <!-- Breadcrumb Description -->
            <p class="text-gray-500 mt-1 text-xs">كل بيانات الفنيين، وثائقهم، وحالة حسابهم في مكان واحد</p>
            
            <!-- Status Tabs & Search -->
            <div class="mt-3 flex items-center justify-between flex-wrap gap-3">
                <!-- Status Tabs -->
                <div class="flex items-center gap-1 bg-gray-100 p-1 rounded-lg">
                    <button 
                        (click)="selectTab('all')" 
                        [class]="activeTab === 'all' ? 'bg-white shadow-sm' : 'hover:bg-gray-200'"
                        class="px-3 py-1.5 text-xs rounded-md transition">
                        الكل (قيد الانتظار + مرفوض)
                        <span class="mr-1 bg-gray-200 px-1.5 py-0.5 rounded-full text-[10px]">{{ allCount }}</span>
                    </button>
                    <button 
                        (click)="selectTab('pending')" 
                        [class]="activeTab === 'pending' ? 'bg-white shadow-sm' : 'hover:bg-gray-200'"
                        class="px-3 py-1.5 text-xs rounded-md transition">
                        قيد الانتظار
                        <span class="mr-1 bg-yellow-100 text-yellow-700 px-1.5 py-0.5 rounded-full text-[10px]">{{ pendingCount }}</span>
                    </button>
                    <button 
                        (click)="selectTab('rejected')" 
                        [class]="activeTab === 'rejected' ? 'bg-white shadow-sm' : 'hover:bg-gray-200'"
                        class="px-3 py-1.5 text-xs rounded-md transition">
                        مرفوض
                        <span class="mr-1 bg-red-100 text-red-700 px-1.5 py-0.5 rounded-full text-[10px]">{{ rejectedCount }}</span>
                    </button>
                </div>

                <!-- Search Bar -->
                <div class="w-full max-w-[180px] sm:max-w-xs">
                    <input 
                        type="text" 
                        placeholder="ابحث برقم الهاتف..." 
                        [(ngModel)]="searchQuery"
                        class="w-full p-1.5 text-sm border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                    />
                </div>
            </div>

            <!-- Requests Table -->
            <div class="mt-4 bg-white rounded-lg border border-blue-700 overflow-hidden">
                @if (loading) {
                <app-loading-spinner message="جاري تحميل الطلبات..."></app-loading-spinner>
                } @else {
                <div class="overflow-x-auto">
                    <table class="min-w-[720px] w-full text-sm border-separate border-spacing-0">
                    <thead>
                        <tr class="bg-gray-50 text-gray-700 text-xs border-b border-blue-700">
                            <th class="py-2.5 px-3 text-right font-medium">الاسم</th>
                            <th class="py-2.5 px-3 text-right font-medium">رقم التلفون</th>
                            <th class="py-2.5 px-3 text-right font-medium">الحرفة</th>
                            <th class="py-2.5 px-3 text-right font-medium">المحافظة / المدينة</th>
                            <th class="py-2.5 px-3 text-right font-medium">الوثائق</th>
                            <th class="py-2.5 px-3 text-right font-medium">الحالة</th>
                            <th class="py-2.5 px-3 text-right font-medium">الإجراءات</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-blue-700">
                        @for (request of filteredRequests; track request.id) {
                        <tr class="hover:bg-gray-50">
                            <td class="py-2.5 px-3">{{ request.name }}</td>
                            <td class="py-2.5 px-3 font-mono text-xs">{{ request.phoneNumber }}</td>
                            <td class="py-2.5 px-3">
                                <span class="bg-blue-100 text-blue-700 px-2 py-0.5 rounded-full text-xs">{{ request.serviceType }}</span>
                            </td>
                            <td class="py-2.5 px-3">{{ request.location }}</td>
                            <td class="py-2.5 px-3">
                                <button (click)="openDocumentModal(request)" class="flex items-center gap-1 text-[#3775FA] hover:text-blue-700 transition">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"/><circle cx="12" cy="12" r="3"/></svg>
                                    <span class="text-xs">عرض</span>
                                </button>
                            </td>
                            <td class="py-2.5 px-3">
                                @if (request.status === 'pending') {
                                    <span class="bg-yellow-100 text-yellow-700 px-2 py-0.5 rounded-full text-xs">قيد الانتظار</span>
                                } @else if (request.status === 'approved') {
                                    <span class="bg-green-100 text-green-700 px-2 py-0.5 rounded-full text-xs">مقبول</span>
                                } @else {
                                    <span class="bg-red-100 text-red-700 px-2 py-0.5 rounded-full text-xs">مرفوض</span>
                                }
                            </td>
                            <td class="py-2.5 px-3">
                                @if (request.status === 'pending') {
                                <div class="flex items-center gap-1">
                                    <button (click)="approveRequest(request)" class="p-1.5 bg-green-500 hover:bg-green-600 text-white rounded transition" title="قبول">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg>
                                    </button>
                                    <button (click)="openRejectModal(request)" class="p-1.5 bg-red-500 hover:bg-red-600 text-white rounded transition" title="رفض">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
                                    </button>
                                </div>
                                } @else {
                                <span class="text-gray-400 text-xs">—</span>
                                }
                            </td>
                        </tr>
                        }
                    </tbody>
                    </table>
                </div>

                <!-- Empty State -->
                @if (filteredRequests.length === 0) {
                <div class="py-12 text-center text-gray-400">
                    <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="mx-auto mb-3"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="12" y1="18" x2="12" y2="12"/><line x1="9" y1="15" x2="15" y2="15"/></svg>
                    <p>لا توجد طلبات</p>
                </div>
                }
                }
            </div>

            @if (!error && totalItems > 0) {
            <app-pagination
                class="mt-4"
                [pageNumber]="pageNumber"
                [pageSize]="pageSize"
                [totalItems]="totalItems"
                [pageSizeOptions]="pageSizeOptions"
                [exactTotal]="hasExactTotal"
                [hasNextPage]="hasNextPage"
                [loading]="loading"
                (pageChange)="onPageChange($event)"
                (pageSizeChange)="onPageSizeChange($event)"
            ></app-pagination>
            }
        </main>
    </div>
</div>

<!-- Document Viewer Modal -->
@if (isDocumentModalOpen) {
<div class="fixed inset-0 bg-black/50 flex items-center justify-center z-50" (click)="closeDocumentModal()">
    <div class="bg-white rounded-2xl shadow-2xl w-[720px] max-w-[95vw] max-h-[90vh] overflow-hidden" dir="rtl" (click)="$event.stopPropagation()">
        <!-- Modal Header -->
        <div class="flex items-center justify-between p-4 border-b border-gray-200">
            <div>
                <h2 class="text-lg font-semibold text-gray-800">المستندات</h2>
                <p class="text-xs text-gray-500">{{ selectedRequest?.name }} • {{ selectedRequest?.phoneNumber }}</p>
            </div>
            <button (click)="closeDocumentModal()" class="p-1.5 hover:bg-gray-100 rounded-full transition">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
            </button>
        </div>
        
        <!-- Modal Body -->
        <div class="p-4">
            <!-- Document Type Tabs -->
            <div class="flex gap-2 mb-4">
                <button 
                    (click)="selectedDocType = 'front'" 
                    [class]="selectedDocType === 'front' ? 'bg-[#3775FA] text-white' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'"
                    class="px-3 py-1.5 text-xs rounded-md transition">
                    البطاقة الأمامية
                </button>
                <button 
                    (click)="selectedDocType = 'back'" 
                    [class]="selectedDocType === 'back' ? 'bg-[#3775FA] text-white' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'"
                    class="px-3 py-1.5 text-xs rounded-md transition">
                    البطاقة الخلفية
                </button>
                <button 
                    (click)="selectedDocType = 'criminal'" 
                    [class]="selectedDocType === 'criminal' ? 'bg-[#3775FA] text-white' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'"
                    class="px-3 py-1.5 text-xs rounded-md transition">
                    الفيش الجنائي
                </button>
            </div>

            <!-- Document Title -->
            <h3 class="text-sm font-medium text-gray-700 mb-3">
                @if (selectedDocType === 'front') {
                    صورة البطاقة الأمامية
                } @else if (selectedDocType === 'back') {
                    صورة البطاقة الخلفية
                } @else {
                    صورة الفيش الجنائي
                }
            </h3>

            <!-- Main Document Image -->
            <div class="bg-gray-100 rounded-lg h-[420px] flex items-center justify-center border border-gray-200">
                @if (getDocumentUrl(selectedDocType); as docUrl) {
                <img [src]="docUrl" alt="صورة المستند" class="max-h-full max-w-full object-contain rounded-lg shadow-sm border border-blue-100">
                } @else {
                <div class="text-center text-gray-400">
                    <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="mx-auto mb-2"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg>
                    <p class="text-sm">لم يتم تحميل هذا المستند</p>
                </div>
                }
            </div>

            <!-- Thumbnail Previews -->
            <div class="flex gap-2 mt-4">
                <button 
                    (click)="selectedDocType = 'front'"
                    [class]="selectedDocType === 'front' ? 'ring-2 ring-[#3775FA]' : 'opacity-60 hover:opacity-100'"
                    class="w-20 h-16 bg-gray-200 rounded-md flex items-center justify-center overflow-hidden transition">
                    @if (getDocumentUrl('front'); as frontUrl) {
                    <img [src]="frontUrl" alt="أمامية" class="w-full h-full object-cover">
                    } @else {
                    <span class="text-[10px] text-gray-500">أمامية</span>
                    }
                </button>
                <button 
                    (click)="selectedDocType = 'back'"
                    [class]="selectedDocType === 'back' ? 'ring-2 ring-[#3775FA]' : 'opacity-60 hover:opacity-100'"
                    class="w-20 h-16 bg-gray-200 rounded-md flex items-center justify-center overflow-hidden transition">
                    @if (getDocumentUrl('back'); as backUrl) {
                    <img [src]="backUrl" alt="خلفية" class="w-full h-full object-cover">
                    } @else {
                    <span class="text-[10px] text-gray-500">خلفية</span>
                    }
                </button>
                <button 
                    (click)="selectedDocType = 'criminal'"
                    [class]="selectedDocType === 'criminal' ? 'ring-2 ring-[#3775FA]' : 'opacity-60 hover:opacity-100'"
                    class="w-20 h-16 bg-gray-200 rounded-md flex items-center justify-center overflow-hidden transition">
                    @if (getDocumentUrl('criminal'); as criminalUrl) {
                    <img [src]="criminalUrl" alt="الفيش" class="w-full h-full object-cover">
                    } @else {
                    <span class="text-[10px] text-gray-500">الفيش</span>
                    }
                </button>
            </div>
        </div>
    </div>
</div>
}

<!-- Rejection Modal -->
@if (isRejectModalOpen) {
<div class="fixed inset-0 bg-black/50 flex items-center justify-center z-50" (click)="closeRejectModal()">
    <div class="bg-white rounded-xl shadow-2xl w-[450px] overflow-hidden" dir="rtl" (click)="$event.stopPropagation()">
        <!-- Modal Header -->
        <div class="flex items-center justify-between p-4 border-b border-gray-200">
            <h2 class="text-lg font-semibold text-gray-800">سبب الرفض</h2>
            <button (click)="closeRejectModal()" class="p-1.5 hover:bg-gray-100 rounded-full transition">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
            </button>
        </div>
        
        <!-- Modal Body -->
        <div class="p-4">
            <!-- Applicant Info -->
            <div class="bg-gray-50 rounded-lg p-3 mb-4">
                <p class="text-sm font-medium text-gray-700">{{ requestToReject?.name }}</p>
                <p class="text-xs text-gray-500">{{ requestToReject?.phoneNumber }} • {{ requestToReject?.serviceType }}</p>
            </div>

            <!-- Document Checklist -->
            <div class="mb-4">
                <label class="block text-xs text-gray-500 mb-2">حدد الوثائق غير الصالحة:</label>
                <div class="space-y-2">
                    <label class="flex items-center gap-2 cursor-pointer">
                        <input type="checkbox" [(ngModel)]="rejectionData.invalidFrontId" class="w-4 h-4 text-red-500 rounded border-gray-300 focus:ring-red-500">
                        <span class="text-sm text-gray-700">صورة البطاقة الأمامية</span>
                    </label>
                    <label class="flex items-center gap-2 cursor-pointer">
                        <input type="checkbox" [(ngModel)]="rejectionData.invalidBackId" class="w-4 h-4 text-red-500 rounded border-gray-300 focus:ring-red-500">
                        <span class="text-sm text-gray-700">صورة البطاقة الخلفية</span>
                    </label>
                    <label class="flex items-center gap-2 cursor-pointer">
                        <input type="checkbox" [(ngModel)]="rejectionData.invalidCriminalRecord" class="w-4 h-4 text-red-500 rounded border-gray-300 focus:ring-red-500">
                        <span class="text-sm text-gray-700">صورة الفيش الجنائي</span>
                    </label>
                </div>
            </div>

            <!-- Reason Dropdown -->
            <div class="mb-4">
                <label class="block text-xs text-gray-500 mb-1">اختر سبب الرفض</label>
                <select 
                    [(ngModel)]="rejectionData.reason"
                    class="w-full p-2 text-sm border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white">
                    <option value="">-- اختر سبب --</option>
                    @for (reason of rejectionReasons; track reason) {
                    <option [value]="reason">{{ reason }}</option>
                    }
                </select>
            </div>

            <!-- Custom Reason Input -->
            <div class="mb-4">
                <label class="block text-xs text-gray-500 mb-1">تفاصيل أخرى (اختياري)</label>
                <textarea 
                    [(ngModel)]="rejectionData.customReason"
                    placeholder="أضف ملاحظات إضافية..."
                    rows="3"
                    class="w-full p-2 text-sm border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 resize-none"
                ></textarea>
            </div>
        </div>

        <!-- Modal Footer -->
        <div class="flex items-center justify-end gap-2 p-4 border-t border-gray-200 bg-gray-50">
            <button (click)="closeRejectModal()" class="px-4 py-2 text-sm text-gray-600 hover:bg-gray-200 rounded-md transition">
                إلغاء
            </button>
            <button (click)="confirmReject()" class="px-4 py-2 text-sm bg-[#3775FA] hover:bg-blue-600 text-white rounded-md transition">
                إضافة
            </button>
        </div>
    </div>
</div>
}
