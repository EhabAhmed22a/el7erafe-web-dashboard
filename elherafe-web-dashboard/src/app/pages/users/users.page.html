<div class="flex flex-col h-screen" dir="rtl">
    <!-- Header (full width on top) -->
    <app-header (menuToggle)="toggleSidebar()"></app-header>

    <!-- Content Area -->
    <div class="flex flex-1 overflow-hidden bg-gray-200 relative">
        <!-- Sidebar -->
        <div class="hidden lg:block">
            <app-sidebar class="shrink-0"></app-sidebar>
        </div>

        @if (sidebarOpen) {
        <div class="fixed inset-0 z-40 flex lg:hidden">
            <div class="absolute inset-0 bg-black/50" (click)="closeSidebar()"></div>
            <div class="relative ml-auto h-full w-64 bg-white shadow-2xl">
                <button type="button" class="absolute top-3 left-3 text-gray-500 hover:text-gray-700" (click)="closeSidebar()" aria-label="إغلاق القائمة">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
                </button>
                <app-sidebar class="h-full pt-10"></app-sidebar>
            </div>
        </div>
        }

        <!-- Main Content -->
        <main class="flex-1 p-4 bg-white overflow-auto m-3 rounded-2xl text-sm">
            <h1 class="text-xl text-blue-700">المستخدمين</h1>
            <!-- Description -->
            <p class="text-gray-500 mt-1 text-xs">اعرض، عدّل، أو حدّث بيانات العملاء بسهولة</p>
            <!-- Search, Filter & Export Row -->
            <div class="mt-3 flex items-center gap-3 flex-wrap">
                <!-- Search Bar -->
                <div class="w-full max-w-[200px]">
                    <input 
                        type="text" 
                        placeholder="ابحث عن مستخدم..." 
                        [(ngModel)]="searchQuery"
                        class="w-full p-1.5 text-sm border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                    />
                </div>

                

                <!-- Export Button -->
                <button class="flex items-center gap-1.5 bg-[#3775FA] hover:bg-blue-600 text-white px-3 py-1.5 text-sm rounded-md transition">
                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                    <span>تصدير</span>
                </button>
            </div>

            <!-- Users Table -->
            <div class="mt-4 bg-white rounded-lg border border-blue-700 overflow-hidden">
                @if (loading) {
                    <app-loading-spinner message="جاري تحميل المستخدمين..."></app-loading-spinner>
                } @else {
                    <div class="overflow-x-auto">
                        <table class="min-w-[780px] w-full text-sm border-separate border-spacing-0">
                            <thead>
                                <tr class="bg-gray-50 text-gray-700 text-xs border-b border-blue-700">
                                    <th class="py-2.5 px-3 text-right font-medium">الاسم</th>
                                    <th class="py-2.5 px-3 text-right font-medium">رقم الهاتف</th>
                                    <th class="py-2.5 px-3 text-right font-medium">البريد الإلكتروني</th>
                                    <th class="py-2.5 px-3 text-right font-medium">تاريخ التسجيل</th>
                                    <th class="py-2.5 px-3 text-right font-medium">عدد المعاملات</th>
                                    <th class="py-2.5 px-3 text-right font-medium">آخر معاملة</th>
                                    <th class="py-2.5 px-3 text-right font-medium">الإجراءات</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-blue-700">
                                <!-- Error State -->
                                <tr *ngIf="error && !loading">
                                    <td colspan="7" class="py-8 text-center text-red-500">
                                        {{ error }}
                                        <button (click)="fetchUsers()" class="mr-2 text-blue-500 underline">إعادة المحاولة</button>
                                    </td>
                                </tr>

                                <!-- Empty State -->
                                <tr *ngIf="!loading && !error && users.length === 0">
                                    <td colspan="7" class="py-8 text-center text-gray-500">
                                        لا يوجد مستخدمين
                                    </td>
                                </tr>

                                <!-- User Rows -->
                                <tr *ngFor="let user of filteredUsers" class="hover:bg-gray-50">
                                    <td class="py-2.5 px-3">{{ user.name }}</td>
                                    <td class="py-2.5 px-3">{{ user.phoneNumber }}</td>
                                    <td class="py-2.5 px-3">{{ user.email }}</td>
                                    <td class="py-2.5 px-3">{{ user.createdAt ? (user.createdAt | date:'yyyy/MM/dd') : '-' }}</td>
                                    <td class="py-2.5 px-3">{{ user.transactionsCount || 0 }}</td>
                                    <td class="py-2.5 px-3 text-gray-500">{{ user.lastTransaction || '-' }}</td>
                                    <td class="py-2.5 px-3">
                                        <div class="flex items-center gap-1">
                                            <button
                                                *ngIf="!user.isBlocked"
                                                (click)="blockUser(user)"
                                                class="p-1.5 text-yellow-500 hover:bg-yellow-50 rounded-md transition"
                                                title="Block"
                                            >
                                                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14"
                                                    viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                                    stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                    <circle cx="12" cy="12" r="10"/>
                                                    <path d="m4.9 4.9 14.2 14.2"/>
                                                </svg>
                                            </button>
                                            <button
                                                *ngIf="user.isBlocked"
                                                (click)="unblockUser(user)"
                                                class="p-1.5 text-green-600 hover:bg-green-50 rounded-md transition"
                                                title="رفع الحظر"
                                            >
                                                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                    <rect x="3" y="11" width="18" height="8" rx="2"/>
                                                    <path d="M7 11V7a5 5 0 0 1 10 0v4"/>
                                                </svg>
                                            </button>

                                            <button (click)="deleteUser(user.id)" class="p-1.5 text-red-500 hover:bg-red-50 rounded-md transition" title="حذف">
                                                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></svg>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    @if (!error && filteredUsers.length === 0) {
                        <div class="py-12 text-center text-gray-400">
                            <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="mx-auto mb-3"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>
                            <p>لا توجد نتائج</p>
                        </div>
                    }
                }
            </div>

            <app-pagination
                class="mt-4"
                *ngIf="!error && totalItems > 0"
                [pageNumber]="pageNumber"
                [pageSize]="pageSize"
                [totalItems]="totalItems"
                [pageSizeOptions]="pageSizeOptions"
                [exactTotal]="hasExactTotal"
                [hasNextPage]="hasNextPage"
                [loading]="loading"
                (pageChange)="onPageChange($event)"
                (pageSizeChange)="onPageSizeChange($event)"
            ></app-pagination>
        </main>
    </div>
</div>

@if (blockModal.open) {
<div class="fixed inset-0 z-50 flex items-center justify-center bg-black/40" dir="rtl">
    <div class="bg-white rounded-2xl w-full max-w-md p-6">
        <h2 class="text-lg font-semibold text-gray-800 mb-2">إعدادات حظر المستخدم</h2>
        <p class="text-sm text-gray-500 mb-4">حدد ما إذا كان الحظر مؤقتاً أو دائماً.</p>
        <div class="space-y-3">
            <label class="flex items-center gap-2 text-sm cursor-pointer">
                <input type="radio" class="text-blue-600" name="userBlockDuration" value="temporary" [(ngModel)]="blockModal.durationType">
                <span>حظر مؤقت</span>
            </label>
            <div class="pl-6" *ngIf="blockModal.durationType === 'temporary'">
                <label class="block text-xs text-gray-500 mb-1">عدد الأيام</label>
                <input type="number" min="1" max="90" [(ngModel)]="blockModal.days" class="w-24 border border-gray-300 rounded-md p-1 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" />
            </div>
            <label class="flex items-center gap-2 text-sm cursor-pointer">
                <input type="radio" class="text-blue-600" name="userBlockDuration" value="permanent" [(ngModel)]="blockModal.durationType">
                <span>حظر دائم</span>
            </label>
        </div>
        <div class="mt-6 flex justify-end gap-2">
            <button class="px-4 py-2 text-sm text-gray-600 hover:bg-gray-100 rounded-md" (click)="closeBlockModal()">إلغاء</button>
            <button class="px-4 py-2 text-sm bg-[#3775FA] text-white rounded-md" (click)="confirmBlockModal()">تأكيد</button>
        </div>
    </div>
</div>
}

<app-confirmation-dialog
    *ngIf="confirmDialog.open"
    [title]="confirmDialog.title"
    [message]="confirmDialog.message"
    [confirmLabel]="confirmDialog.confirmLabel"
    [cancelLabel]="confirmDialog.cancelLabel"
    [variant]="confirmDialog.variant"
    (confirm)="handleConfirmDialog()"
    (cancel)="closeConfirmDialog()"
></app-confirmation-dialog>