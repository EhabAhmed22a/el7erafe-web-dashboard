<div class="flex flex-col h-screen" dir="rtl">
    <app-header (menuToggle)="toggleSidebar()"></app-header>
    <div class="flex flex-1 overflow-hidden bg-gray-200 relative">
        <div class="hidden lg:block">
            <app-sidebar class="shrink-0"></app-sidebar>
        </div>

        @if (sidebarOpen) {
        <div class="fixed inset-0 z-40 flex lg:hidden">
            <div class="absolute inset-0 bg-black/50" (click)="closeSidebar()"></div>
            <div class="relative ml-auto h-full w-64 bg-white shadow-2xl">
                <button type="button" class="absolute top-3 left-3 text-gray-500 hover:text-gray-700" (click)="closeSidebar()" aria-label="إغلاق القائمة">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
                </button>
                <app-sidebar class="h-full pt-10"></app-sidebar>
            </div>
        </div>
        }

        <main class="flex-1 p-4 bg-white overflow-auto m-3 rounded-2xl text-sm">
            <h1 class="text-xl text-blue-700">الفنيين</h1>
            <p class="text-gray-500 mt-1 text-xs">كل بيانات الفنيين، وثائقهم، وحالة حسابهم في مكان واحد</p>
            <div class="mt-3 flex items-center gap-3 flex-wrap">
                <div class="flex-1 min-w-[200px]">
                    <input
                        type="text"
                        placeholder="ابحث عن فني..."
                        [(ngModel)]="searchQuery"
                        class="w-full p-1.5 text-sm border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                    />
                </div>
                
                <button class="flex items-center gap-1.5 bg-[#3775FA] hover:bg-blue-600 text-white px-3 py-1.5 text-sm rounded-md transition">
                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                    <span>تصدير</span>
                </button>
            </div>
            <div class="mt-4 bg-white rounded-lg border">
                <div class="overflow-x-auto">
                    <table class="min-w-[860px] w-full text-sm">
                    <thead>
                        <tr class="bg-gray-100 text-gray-600 text-xs">
                            <th class="py-2.5 px-3 text-right font-medium border-b border-gray-200">الاسم</th>
                            <th class="py-2.5 px-3 text-right font-medium border-b border-gray-200">رقم التلفون</th>
                            <th class="py-2.5 px-3 text-right font-medium border-b border-gray-200">الحرفة</th>
                            <th class="py-2.5 px-3 text-right font-medium border-b border-gray-200">المحافظة / المدينة</th>
                            <th class="py-2.5 px-3 text-right font-medium border-b border-gray-200">الرقم القومي</th>
                            <th class="py-2.5 px-3 text-right font-medium border-b border-gray-200">وثائق</th>
                            <th class="py-2.5 px-3 text-right font-medium border-b border-gray-200">الإجراءات</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr *ngIf="loading">
                            <td colspan="7" class="py-8 text-center text-gray-500">جاري التحميل...</td>
                        </tr>
                        <tr *ngIf="error && !loading">
                            <td colspan="7" class="py-8 text-center text-red-500">{{ error }}</td>
                        </tr>
                        <tr *ngIf="!loading && !error && technicians.length === 0">
                            <td colspan="7" class="py-8 text-center text-gray-500">لا يوجد فنيين</td>
                        </tr>
                        <tr *ngFor="let tech of filteredTechnicians" class="hover:bg-gray-50">
                            <td class="py-2.5 px-3 border-b border-gray-200">{{ tech.name }}</td>
                            <td class="py-2.5 px-3 border-b border-gray-200">{{ tech.phone }}</td>
                            <td class="py-2.5 px-3 border-b border-gray-200">{{ tech.serviceType || '-' }}</td>
                            <td class="py-2.5 px-3 border-b border-gray-200">{{ tech.governorate }} / {{ tech.city }}</td>
                            <td class="py-2.5 px-3 border-b border-gray-200 font-mono text-xs">-</td>
                            <td class="py-2.5 px-3 border-b border-gray-200">
                                <button class="flex items-center gap-1 text-[#3775FA] hover:text-blue-700 transition"
                                        [disabled]="!tech.faceIdImage && !tech.backIdImage && !tech.criminalRecordImage"
                                        (click)="openDocumentModal(tech)">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"/><circle cx="12" cy="12" r="3"/></svg>
                                    <span class="text-xs">عرض</span>
                                </button>
                            </td>
                            <td class="py-2.5 px-3 border-b border-gray-200">
                                <div class="flex items-center gap-1">
                                    <button
                                        *ngIf="!tech.isBlocked"
                                        (click)="blockTechnician(tech)"
                                        class="p-1.5 text-yellow-500 hover:bg-yellow-50 rounded-md transition"
                                        title="حظر"
                                    >
                                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                            <circle cx="12" cy="12" r="10"/>
                                            <path d="m4.9 4.9 14.2 14.2"/>
                                        </svg>
                                    </button>
                                    <button
                                        *ngIf="tech.isBlocked"
                                        (click)="unblockTechnician(tech)"
                                        class="p-1.5 text-green-600 hover:bg-green-50 rounded-md transition"
                                        title="رفع الحظر"
                                    >
                                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                            <circle cx="12" cy="12" r="10"/>
                                            <path d="M9 12l2 2 4-4"/>
                                        </svg>
                                    </button>
                                    <button (click)="deleteTechnician(tech.id)" class="p-1.5 text-red-500 hover:bg-red-50 rounded-md transition" title="حذف">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></svg>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                    </table>
                </div>
            </div>

            <app-pagination
                class="mt-4"
                *ngIf="!error && totalItems > 0"
                [pageNumber]="pageNumber"
                [pageSize]="pageSize"
                [totalItems]="totalItems"
                [pageSizeOptions]="pageSizeOptions"
                [exactTotal]="hasExactTotal"
                [hasNextPage]="hasNextPage"
                [loading]="loading"
                (pageChange)="onPageChange($event)"
                (pageSizeChange)="onPageSizeChange($event)"
            ></app-pagination>
        </main>
    </div>
</div>

<!-- Document Modal -->
<div *ngIf="isModalOpen" class="fixed inset-0 z-50 flex items-center justify-center" style="background: rgba(0,0,0,0.10);">
    <div class="bg-white rounded-lg shadow-lg w-full max-w-md p-6 relative z-10">
        <button (click)="closeDocumentModal()" class="absolute top-2 left-2 text-gray-400 hover:text-gray-700">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
        </button>
        <h2 class="text-lg font-semibold text-blue-700 mb-2">وثائق الفني</h2>
        <div *ngIf="selectedTechnician">
            <div class="flex justify-center gap-2 mb-4">
                <button (click)="selectedDocType = 'front'" [class.bg-blue-100]="selectedDocType === 'front'" class="px-3 py-1 rounded transition border border-blue-200" [class.text-blue-700]="selectedDocType === 'front'">الوجه</button>
                <button (click)="selectedDocType = 'back'" [class.bg-blue-100]="selectedDocType === 'back'" class="px-3 py-1 rounded transition border border-blue-200" [class.text-blue-700]="selectedDocType === 'back'">الظهر</button>
                <button (click)="selectedDocType = 'criminal'" [class.bg-blue-100]="selectedDocType === 'criminal'" class="px-3 py-1 rounded transition border border-blue-200" [class.text-blue-700]="selectedDocType === 'criminal'">فيش جنائي</button>
            </div>
            <div class="flex flex-col items-center">
                <ng-container [ngSwitch]="selectedDocType">
                    <ng-container *ngSwitchCase="'front'">
                        <ng-container *ngIf="selectedTechnician.faceIdImage; else noFront">
                            <img [src]="environment.apiUrl + '/api/Files/technician/' + selectedTechnician.faceIdImage" alt="صورة الوجه" class="max-w-full max-h-80 rounded border" />
                        </ng-container>
                        <ng-template #noFront>
                            <p class="text-gray-400">لا توجد صورة للوجه</p>
                        </ng-template>
                    </ng-container>
                    <ng-container *ngSwitchCase="'back'">
                        <ng-container *ngIf="selectedTechnician.backIdImage; else noBack">
                            <img [src]="environment.apiUrl + '/api/Files/technician/' + selectedTechnician.backIdImage" alt="صورة الظهر" class="max-w-full max-h-80 rounded border" />
                        </ng-container>
                        <ng-template #noBack>
                            <p class="text-gray-400">لا توجد صورة للظهر</p>
                        </ng-template>
                    </ng-container>
                    <ng-container *ngSwitchCase="'criminal'">
                        <ng-container *ngIf="selectedTechnician.criminalRecordImage; else noCriminal">
                            <img [src]="environment.apiUrl + '/api/Files/technician/' + selectedTechnician.criminalRecordImage" alt="فيش جنائي" class="max-w-full max-h-80 rounded border" />
                        </ng-container>
                        <ng-template #noCriminal>
                            <p class="text-gray-400">لا يوجد فيش جنائي</p>
                        </ng-template>
                    </ng-container>
                </ng-container>
            </div>
        </div>
    </div>
</div>

<app-confirmation-dialog
    *ngIf="confirmDialog.open"
    [title]="confirmDialog.title"
    [message]="confirmDialog.message"
    [confirmLabel]="confirmDialog.confirmLabel"
    [cancelLabel]="confirmDialog.cancelLabel"
    [variant]="confirmDialog.variant"
    (confirm)="handleConfirmDialog()"
    (cancel)="closeConfirmDialog()"
></app-confirmation-dialog>
